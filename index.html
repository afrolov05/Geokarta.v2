<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Geo Cashback MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --bg-main: #05060a;
      --bg-card: #15161c;
      --bg-card-soft: #1f2027;
      --bg-chip: #262730;
      --bg-tab: #1f2027;
      --txt-main: #ffffff;
      --txt-soft: #c4c4d0;
      --txt-muted: #8f90a0;
      --radius-xl: 26px;
      --accent-red: #ff3859;
      --accent-orange: #ff9f30;
      --accent-lime: #29d9a6;
      --accent-purple: #7c5cff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      font-family: system-ui, -apple-system, "SF Pro Display", sans-serif;
    }

    body {
      background: var(--bg-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      color: var(--txt-main);
    }

    .app-shell {
      width: 100%;
      max-width: 430px;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background: var(--bg-main);
    }

    @media (min-width: 768px) {
      .app-shell {
        margin: 16px auto;
        height: calc(100vh - 32px);
        border-radius: 30px;
        box-shadow: 0 18px 45px rgba(0,0,0,0.7);
      }
    }

    #map {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    /* ===== TOP BAR (–Ω–∞–∑–≤–∞–Ω–∏–µ + –Ω–∞–∑–∞–¥) ===== */

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 52px;
      z-index: 5;
      display: none;
      align-items: center;
      gap: 10px;
      padding: 0 14px;
      background: linear-gradient(
        to bottom,
        rgba(5,6,10,0.95),
        rgba(5,6,10,0.6),
        transparent
      );
    }

    .top-bar.show {
      display: flex;
    }

    .btn-back {
      font-size: 22px;
      cursor: pointer;
      opacity: 0.9;
    }

    .top-title {
      font-size: 15px;
      font-weight: 600;
    }

    /* ===== BOTTOM PANEL ===== */

    .bottom-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px 16px;
      z-index: 3;
      background: linear-gradient(
        to top,
        rgba(5, 6, 10, 0.98),
        rgba(5, 6, 10, 0.7),
        transparent
      );
      pointer-events: none;
    }

    .bottom-inner {
      pointer-events: auto;
    }

    .tabs-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tab {
      flex: 1;
      text-align: center;
      background: var(--bg-tab);
      color: var(--txt-soft);
      padding: 8px 4px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
    }

    .tab.active {
      background: linear-gradient(145deg, #ff7b5f, #ff2140);
      color: #fff;
      font-weight: 600;
    }

    /* ===== GUIDE BANNER (—É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π) ===== */

    .guide-banner {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .guide-banner-title {
      font-size: 13px;
      font-weight: 600;
    }

    .guide-banner-arrow {
      font-size: 18px;
      opacity: 0.8;
    }

    /* ===== FULL GUIDE SCREEN ===== */

    .guide-screen {
      position: absolute;
      inset: 0;
      z-index: 6;
      display: none;
      background: var(--bg-main);
    }

    .guide-screen.show {
      display: block;
    }

    /* ===== HEAT MODE FIX ===== */

    .heat-hide {
      display: none !important;
    }

    /* ===== LOCATE BUTTON ===== */

    .btn-locate {
      position: absolute;
      right: 16px;
      bottom: 210px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      z-index: 3;
      background: radial-gradient(circle at 30% 0, #4bffe5, #1b1c24);
      border: none;
      cursor: pointer;
      font-size: 18px;
    }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- MAP -->
  <div id="map"></div>

  <!-- TOP BAR (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥) -->
  <div class="top-bar" id="topBar">
    <div class="btn-back" id="btnBack">‚Üê</div>
    <div class="top-title" id="topTitle"></div>
  </div>

  <!-- LOCATE -->
  <button id="btnLocate" class="btn-locate">üìç</button>

  <!-- ===== BOTTOM PANEL (MAIN SCREEN) ===== -->
  <div class="bottom-panel" id="mainBottom">
    <div class="bottom-inner">

      <div class="tabs-row">
        <div class="tab active" id="tabCashback">–í–∞—à –∫—ç—à–±—ç–∫</div>
        <div class="tab" id="tabNearby">–†—è–¥–æ–º —Å –≤–∞–º–∏</div>
      </div>

      <!-- GUIDE PREVIEW BANNER -->
      <div class="guide-banner" id="openGuide">
        <div class="guide-banner-title">–ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω–∞–º</div>
        <div class="guide-banner-arrow">‚Ä∫</div>
      </div>

    </div>
  </div>

  <!-- ===== GUIDE FULL SCREEN ===== -->
  <div class="guide-screen" id="guideScreen">

    <div class="top-bar show">
      <div class="btn-back" id="guideBack">‚Üê</div>
      <div class="top-title">–ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω—É</div>
    </div>

    <div class="bottom-panel">
      <div class="bottom-inner">

        <div class="card-guide">
          <div class="guide-title" id="guideTitle"></div>
          <div class="guide-subtitle" id="guideSubtitle"></div>

          <div class="guide-steps" id="guideSteps"></div>

          <div class="guide-place-card" id="guidePlaceCard">
            <div>
              <div class="guide-place-name" id="placeName"></div>
              <div class="guide-place-address" id="placeAddress"></div>
            </div>
            <div class="guide-place-meta">
              <div class="tag" id="placeCategory"></div>
              <div id="placeDistance"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- ===== NEARBY LIST SCREEN ===== -->
  <div class="guide-screen" id="nearbyScreen">

    <div class="top-bar show">
      <div class="btn-back" id="nearbyBack">‚Üê</div>
      <div class="top-title">–†—è–¥–æ–º —Å –≤–∞–º–∏</div>
    </div>

    <div class="bottom-panel">
      <div class="bottom-inner">
        <div id="nearbyList"></div>
      </div>
    </div>

  </div>

  <!-- ===== HEATMAP SCREEN ===== -->
  <div class="guide-screen" id="heatScreen">

    <div class="top-bar show">
      <div class="btn-back" id="heatBack">‚Üê</div>
      <div class="top-title">–°—Ä–µ–¥–Ω–∏–π –∫—ç—à–±—ç–∫ –ø–æ —Ä–∞–π–æ–Ω–∞–º</div>
    </div>

    <div class="bottom-panel">
      <div class="bottom-inner">
        <div class="guide-title">
          –ö–ª–∏–∫–∞–π –ø–æ –∫—Ä—É–≥–∞–º –Ω–∞ –∫–∞—Ä—Ç–µ
        </div>
      </div>
    </div>

  </div>

</div>
<script>
/* ========= GLOBAL STATE ========= */

let allPlaces = [];
let brandLogos = {};
let averageZones = [];

let userPosition = null;
let userMarker = null;

let markersLayer = L.layerGroup();
let heatLayer = L.layerGroup();

let guidePlaces = [];
let currentStep = 0;

/* ========= MAP ========= */

const map = L.map("map").setView([55.75, 37.62], 11);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { maxZoom: 19 }
).addTo(map);

markersLayer.addTo(map);

/* ========= LOAD DATA ========= */

async function loadData() {
  const [points, brands, zones] = await Promise.all([
    fetch("points.json"),
    fetch("brands.json"),
    fetch("average-zones.json")
  ]);

  allPlaces = await points.json();
  brandLogos = await brands.json();
  averageZones = await zones.json();

  initUI();
}

loadData();

/* ========= HELPERS ========= */

function catColor(c) {
  switch (c) {
    case "–ê–ó–°": return "#ff3859";
    case "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ": return "#ff9f30";
    case "–°–ø–æ—Ä—Ç—Ç–æ–≤–∞—Ä—ã": return "#29d9a6";
    case "–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": return "#7c5cff";
    default: return "#ffffff";
  }
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function distFmt(km) {
  return km < 1
    ? Math.round(km * 1000) + " –º"
    : km.toFixed(1) + " –∫–º";
}

/* ========= UI ========= */

function initUI() {
  document.getElementById("btnLocate").onclick = requestLocation;

  document.getElementById("openGuide").onclick = () => {
    openScreen("guide");
    buildGuide();
  };

  document.getElementById("tabNearby").onclick = () => {
    if (!userPosition) return requestLocation(() => openNearby());
    openNearby();
  };

  document.getElementById("tabCashback").onclick = () => {
    openHeat();
  };

  document.getElementById("btnBack").onclick =
  document.getElementById("guideBack").onclick =
  document.getElementById("nearbyBack").onclick =
  document.getElementById("heatBack").onclick = closeAllScreens;
}

/* ========= LOCATION ========= */

function requestLocation(cb) {
  navigator.geolocation.getCurrentPosition(pos => {
    userPosition = {
      lat: pos.coords.latitude,
      lon: pos.coords.longitude
    };

    if (!userMarker) {
      userMarker = L.circleMarker(
        [userPosition.lat, userPosition.lon],
        { radius: 6, color: "#00ffb3" }
      ).addTo(map);
    }

    map.setView([userPosition.lat, userPosition.lon], 13);

    if (cb) cb();
  });
}

/* ========= SCREENS ========= */

function openScreen(name) {
  closeAllScreens();

  document.getElementById("topBar").classList.add("show");

  if (name === "guide") {
    document.getElementById("guideScreen").classList.add("show");
    document.getElementById("topTitle").textContent = "–ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω—É";
  }

  if (name === "nearby") {
    document.getElementById("nearbyScreen").classList.add("show");
    document.getElementById("topTitle").textContent = "–†—è–¥–æ–º —Å –≤–∞–º–∏";
  }

  if (name === "heat") {
    document.getElementById("heatScreen").classList.add("show");
    document.getElementById("topTitle").textContent = "–°—Ä–µ–¥–Ω–∏–π –∫—ç—à–±—ç–∫";
  }

  document.getElementById("mainBottom").classList.add("heat-hide");
}

function closeAllScreens() {
  ["guideScreen", "nearbyScreen", "heatScreen"]
    .forEach(id => document.getElementById(id).classList.remove("show"));

  document.getElementById("topBar").classList.remove("show");
  document.getElementById("mainBottom").classList.remove("heat-hide");

  markersLayer.clearLayers();
  heatLayer.clearLayers();
}

/* ========= GUIDE ========= */

function buildGuide() {
  if (!userPosition) return;

  guidePlaces = allPlaces
    .filter(p => p.category === "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ")
    .map(p => ({
      ...p,
      dist: haversine(userPosition.lat, userPosition.lon, p.lat, p.lon)
    }))
    .sort((a,b) => a.dist - b.dist)
    .slice(0, 5);

  currentStep = 0;
  renderGuide();
}

function renderGuide() {
  const p = guidePlaces[currentStep];
  if (!p) return;

  document.getElementById("guideTitle").textContent =
    `–®–∞–≥ ${currentStep + 1}. –ü–æ—Å–µ—Ç–∏—Ç–µ ${p.name}`;

  document.getElementById("guideSubtitle").textContent =
    "–ë–ª–∏–∂–∞–π—à–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã —Ä—è–¥–æ–º —Å –≤–∞–º–∏";

  document.getElementById("placeName").textContent = p.name;
  document.getElementById("placeAddress").textContent = p.address;
  document.getElementById("placeCategory").textContent = p.category;
  document.getElementById("placeDistance").textContent = distFmt(p.dist);

  markersLayer.clearLayers();
  createMarker(p);
}

/* ========= NEARBY ========= */

function openNearby() {
  openScreen("nearby");

  const list = document.getElementById("nearbyList");
  list.innerHTML = "";

  allPlaces
    .map(p => ({
      ...p,
      dist: haversine(userPosition.lat, userPosition.lon, p.lat, p.lon)
    }))
    .filter(p => p.dist <= 3)
    .sort((a,b) => a.dist - b.dist)
    .forEach(p => {
      const item = document.createElement("div");
      item.className = "guide-place-card";
      item.innerHTML = `
        <div>
          <div class="guide-place-name">${p.name}</div>
          <div class="guide-place-address">${p.address}</div>
        </div>
        <div class="guide-place-meta">
          <div>${distFmt(p.dist)}</div>
        </div>
      `;
      item.onclick = () => showMarker(p);
      list.appendChild(item);
    });
}

/* ========= MARKERS ========= */

function createMarker(p) {
  const icon = L.divIcon({
    html: `<div style="
      width:14px;height:14px;border-radius:50%;
      background:${catColor(p.category)};
      border:2px solid #05060a"></div>`,
    className: ""
  });

  L.marker([p.lat,p.lon], { icon }).addTo(markersLayer);
}

function showMarker(p) {
  openScreen("nearby");
  markersLayer.clearLayers();
  createMarker(p);
  map.flyTo([p.lat, p.lon], 15);
}

/* ========= HEATMAP ========= */

function openHeat() {
  openScreen("heat");
  buildHeat();
}

function buildHeat() {
  heatLayer.clearLayers();

  averageZones.forEach(z => {
    const color =
      z.value >= 35 ? "#ff3859" :
      z.value >= 25 ? "#ff9f30" :
      "#29d9a6";

    const circle = L.circle([z.lat, z.lon], {
      radius: 400 + z.value * 6,
      color,
      fillColor: color,
      fillOpacity: 0.18,
      weight: 1.2
    }).addTo(heatLayer);

    circle.bindPopup(`<b>${z.name}</b><br>–°—Ä–µ–¥–Ω–∏–π –∫—ç—à–±—ç–∫: ${z.value} ‚ÇΩ`);
  });

  heatLayer.addTo(map);
}
</script>
</body>
</html>
